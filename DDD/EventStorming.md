# 事件风暴
事件风暴（Event Stroming）的引入对DDD而言是一次重要的发展，其提供了一种探索业务复杂性的套路。通过实施事件风暴有助于帮助我们发现有界上下文、上下文映射和领域的划分，而所涉及到的领域设计战略模式是开展DDD的基础和难点，因此通过熟练实施事件风暴套路进而掌握DDD是一个可行的途径。

## 1 什么是事件风暴？
事件风暴是Alberto Brandoliniti提出的一种快速、轻量级且未得到充分认可的群体建模技术（此定义来源Google产品技术经理Steven A. Lowe，原文来自：https://techbeacon.com/devops/introduction-event-storming-easy-way-achieve-domain-driven-design ）。该定义其实有点太概念化不太好理解，更便于理解的说法是：事件风暴是以工作坊的形式围绕领域事件多人展开头脑风暴。

### 1.1 事件风暴围绕领域事件展开，其本质原因何在
维根斯坦是20世纪颇具影响力的哲学家之一，其著作《逻辑哲学论》表达了：“世界是事实的总和，而非事物的总和”的理论。在他看来是世界是由发生着的事实组成的，这里的事实包含了事物、事物的行为以及事物之间的动态关系。因此用人类语言描述所见所闻时，除了关心主语是什么之外，更需要关系谓语是什么。谓语表达的是动作与行为，其是组成事实的一部分。

说完哲学理论，接下来得说下领域事件。那么领域事件是什么？这里可以理解为领域专家对其业务领域感兴趣的、发生的事情与情况，也可以不准确的简单理解为业务流程中发生的行为动作。例如电商中的商品已上架、用户已下单等等。在DDD建模领域，使用“事件”代表“事实”，表达对象之间的关系，同理关系一定来自两个或多个对象。至此可以通过领域事件得到事实（事物+事物行为+事物间关系），事实集合能组成世界，那么通过分析领域事件也可以还原复杂的业务场景。

领域事件表达了至少两个对象之间的关系，那么当领域事件发生在有界上下文是能够帮助找出有界上下文和上下文映射（即有界上下文之间的关系），发生在聚合根维度上能帮助划分出聚合根。通过分析领域事件已经帮助解决了DDD中有界上下文和聚合根划分的难题。以上是事件风暴方法论的背后哲学理论依据。

### 1.2 事件风暴与其它方法论的不同处

- 首先从数据建模开始，那么人们的思考和对话将很快转移到范式、事物和其他非业务领域相关的事情。
- 首先从行为建模开始，当人们将行为分解为任务并将其链接到流程时，会分心或不知道如何下手。

领域事件是数据和行为的结合，其表示的是领域事实，这些事件仅在基础业务发生更改时才会发生明显变化，因此领域事件时DDD建模中更稳定和更具弹性的脚手架。

## 2 事件风暴建模法
找一个会议室，会议室有空旷的白板，准备好各种颜色的便签。参与会议的运营人员、产品经理、开发人员、测试人员、[领域专家]、[交互视觉人员]都到常，且建议尽量都站着、手里都便签纸。从领域事件开始探索领域，按照时间线向前和向后发现领域事件，探索领域事件的源头。中间涉及到命令、用户、事件需要用不同颜色的便签。讨论的粒度可以按：子域->有界上下文.

### 2.1 领域事件
#### 2.1.1 领域事件的定义
文档前面也提到了什么时领域事件，Eric的官方定义是“Something happened that domain experts care about.”。从实际使用的角度来理解就是“某个有业务意义的事情发生了”。

#### 2.1.2 领域事件命名规范
事件代表过去发生的事件、领域事件在命名需要遵循如下规则：
- 必须使用过去式，表示已经发生的事情.如EmployeeJoined-员工入职，SampleShipped-样品已出货
- 因为领域事件表示与领域相关的事件、命名必须代表深刻的业务领域含义。不能使用CRUDish缺乏深度理解的命名方式，如somethingChanged,somethingUpdated,somethingDeleted; 不能使用通用的事物或交易术语，如somethingRollbacked,somethingCancled.这些错误的方式都是没有使用领域中的通用术语，会导致业务概念被隐藏和忽略。

推荐命名格式：业务名词+动词过去式

#### 2.1.3 关键事件
不是所领域事件都意味着状态改变，有一种特使的事件可以识别状态机状态之间的转换，成为关键事件。状态是边界的凝聚核心，可以通过发现状态机来发领域中的上下文边界，因为关键事件是领域边界的有力指标。例如：
在购物车场景和订单场景中，某个商品A买了5件，这是购物车中的条目信息更新会引起购物车状态的变化，但是在订单场景中，购物车明细已经变成了订单明细，订单明细在订单的场景中是不能被修改，订单明细的改变不能引起订单状态的变化。

### 2.2 命令
#### 2.2.1 命令的定义
触发领域事件的行为就叫命令，也可以在实际使用中理解为动作。用用户体验角度看，命令体现了人的一种意图，因为这个意图才触发了这个命令，命令进入领域系统后，系统是否响应执行这个命令，还是需要这个领域自身的逻辑来决定。命令在领域事件之前，是领域事件发生的因。

#### 2.2.2 命名命名规范
命令一般是动词在前，或者结尾使用ing表示正在发生的动作。

推荐命名格式：动词+宾语/动词ing+宾语

### 2.3 实施步骤

1） 头脑风暴，将能想到所有关于业务的领域事件按规范的格式书写，并标记为橙色。可能刚开始能相当的事件离散和粗糙，但是先不用关心。

2） 按照时间线整理这些领域事件，在整理时建议从后往前排列。同时也可以回顾下整个事件线。

3） 在领域事件处加上角色和命令，角色用黄色标记、命令用蓝色标记

4） 加入流程的因果关系，也就是将命令和事件串联起来。此时需要根据加入的因果关系和时间先后顺序进行梳理和分析，尽可能的找出多的逻辑漏洞进而更深一不挖掘业务规则。

5） 将来领域事件和命令用不同的颜色标记出来后基本能对问题空间中的领域知识有一定统一的认识，这时按照逻辑一致的原则找出其中的有界上下文。同时区分出核心子域、支持子域和通用子域。

6） 根据划分出的有界上下文之间的关系紧密度选择适合的上下文映射模式（常用的模式：共享内核[SK]、API的开放主机服务[OHS]、发布语言即发布/订阅模式[PL]）

## 2.4 开展事件风暴要点

【尽情表达】

在召开事件风暴会议时，需要尽情表达自己的观点，阐述自己的主观认识。世界是在语言符号中表达出来的，真实的客观世界如果不使用语言、形式逻辑等符号去表示，就无从认识，只能用一个词表达：那个客观世界，所以，维根斯坦说：语言的边界就是思维的边界，当无法用语言表达时，就达到了认识世界的最大边界了。

【解决混乱】

每个人都尽情表达和主观的说话看上去很混乱，解决方法是：**求同存异，将相同的语言模型放在同一个有界上下文中，差异就使用胡不同的有界上下文来表示**

【不存在可靠明确的业务需求】

可靠明确的需求其实只是一种幻觉，实际中是找不到明确的需求的。因为需求的表达往往带有个人认知“偏见”和逻辑漏洞。这个也是PD和开发之前的巨大鸿沟，在快速支撑业务需求的重要性已成为开发人员普遍共识的情况下，开发人员学会填补产品经理留下的空白，只是为了保持项目不断推进。同时需求的不确定属性常常让开发人员对留下空白处的创造性假设夭折。

作为开发人员必须充分了解问题空间和亲自了解问题的知识，事件风暴让处于信息孤岛的人们发现彼此的有限性，提供给开发人员填补空白处的机会。



